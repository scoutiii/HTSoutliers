#'
#' This take a dataset generated by get_weather_data (or any of the snowload2::get_x_data functions),
#' and flaggs points which were found to be outliers during the national snow load project in 2020.
#'
#' Since outliers were only flagged up to the date 2020-8-1, the default date_max is set to this.
#' This way observations after this point wont be marked as non-outliers when they haven't been checked.
#' It is advised to leave this date as it is.
#'
#' 0 means not an outlier, 1 means outlier
#'
#' @param data the dataset which is to be flagged
#' @param date_max observations after this as.Date() will be removed
#' @param clear_variables leaves variables ID, ELEMENT, DATE, VALUE, OUTLIER_FINAL
#'
#' @return data frame which has
#' @export
#'
#' @importFrom dplyr .data
#'
#' @examples
#' # UT <- get_weather_data("UT")
#' # UT_flagged <- create_flagged_dataset(UT)
create_flagged_dataset <- function(data,
                                   date_max = base::as.Date("2020-8-1"),
                                   clear_variables = TRUE) {

    new_data <- data %>%
        dplyr::filter(.data$DATE <= date_max) %>%
        # This line gets the spooky 1952
        dplyr::mutate(Spooky = !(lubridate::year(.data$DATE) != 1952 | .data$ELEMENT != "WESD")) %>%
        # basically marks the dataset with the outliers dataset
        dplyr::left_join(HTSoutliers::outliers_ghcnd, by = c("ID", "ELEMENT", "DATE", "VALUE")) %>%
        # picks out the needed variables
        dplyr::select(.data$ID, .data$ELEMENT, .data$DATE, .data$VALUE, .data$QFLAG, .data$Spooky, .data$OUTLIER) %>%
        # sets the na values to 0
        dplyr::mutate(OUTLIER = ifelse(is.na(.data$OUTLIER), 0, 1)) %>%
        # flags all values that satisfy any of the conditions
        dplyr::mutate(OUTLIER_FINAL = ifelse(.data$QFLAG != " " | .data$Spooky | .data$OUTLIER == 1, 1, 0))

    if (clear_variables) {
        new_data <-  new_data %>%
            dplyr::select(.data$ID, .data$ELEMENT, .data$DATE, .data$VALUE, .data$OUTLIER_FINAL)
    }

    return(new_data)
}
